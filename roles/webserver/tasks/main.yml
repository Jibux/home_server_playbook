- name: Create directories
  file: path={{ item.path }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} state=directory
  with_items:
    - { path: '/home/www', owner: 'root', group: 'root', mode: '0751' }
    - { path: '/etc/iptables', owner: 'root', group: 'root', mode: '0755' }

- name: Remove some users
  user: name={{ item.name }} state=absent remove=yes
  with_items:
    - { name: 'pi' }

- name: Remove some groups
  group: name={{ item.name }} state=absent
  with_items:
    - { name: 'pi' }

- name: Create groups
  group: name={{ item.name }} gid={{ item.gid }} state=present
  with_items:
    - { name: 'www', gid: 6000 }
    - { name: 'sftp', gid: 6001 }
    - { name: 'jbh', gid: 1000 }
    - { name: 'jb_dedi_web', gid: 2000 }

- name: Create users
  user: name={{ item.name }} uid={{ item.uid }} group={{ item.group }} groups={{ item.groups }} home={{ item.home }} shell={{ item.shell }} password={{ item.password }}
  with_items:
    - { name: 'jbh', uid: 1000, group: 'jbh', home: '/home/jbh', groups: 'sudo', shell: '/bin/bash', password: '$6$QEmOr9SX$fXxwROHbfCfJs/zEVmzACiqPQxVtDA/FbCN3utTxrr/ZWx7FfC2WIQPeTwK7rQym2t0qQjk2NCIXSmn4X3G9d0' }
    - { name: 'jb_dedi_web', uid: 2000, group: 'jb_dedi_web', home: '/home/www/jb_dedi_web', groups: 'www, sftp', shell: '/bin/bash', password: '!' }

- name: Add group to user www-data
  user: name=www-data groups='jb_dedi_web'

- name: Install webserver programs
  apt:
    name: "{{ ['apache2', 'php7.0-fpm', 'sslh', 'openvpn', 'iptables-persistent', 'letsencrypt', 'fail2ban', 'bind9', 'mariadb-server-10.1'] }}"
    state: present

- name: Install php modules
  apt:
    name: "{{ ['php7.0-mysql', 'php-apcu', 'php7.0-pgsql', 'php7.0-intl', 'php7.0-xml', 'php7.0-gd', 'php7.0-curl', 'php7.0-zip', 'php7.0-mbstring', 'php7.0-ldap', 'php7.0-imap', 'php7.0-sqlite3', 'php7.0-bz2'] }}"
    state: present
  register: php_modules_insalled

- name: Install apache2 modules
  apt:
    name: "{{ ['libapache2-mod-wsgi'] }}"
    state: present

- name: Enable apache2 modules
  apache2_module: name={{ item }} state=present ignore_configcheck=yes
  loop: "{{Â ['headers', 'rewrite', 'wsgi', 'ssl', 'proxy', 'proxy_fcgi', 'http2'] }}"

- name: Enable php modules
  shell: phpenmod {{ item }}
  with_items:
    - mysql
    - apcu
    - pgsql
    - json
    - intl
    - simplexml
    - xmlreader
    - xmlwriter
    - xml
    - gd
    - curl
    - zip
    - mbstring
    - ldap
    - imap
    - sqlite3
    - bz2
  when: php_modules_insalled.changed

# Set ip forwarding on in /proc and in the sysctl file and reload if necessary
- sysctl:
    name: net.ipv4.ip_forward
    value: 1
    sysctl_set: yes
    state: present
    reload: yes

- name: Setup configuration files
  copy: owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} src={{ item.src }} dest={{ item.dest }}
  with_items: 
    - { src: 'apache2.conf', dest: '/etc/apache2/apache2.conf', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'ports.conf', dest: '/etc/apache2/ports.conf', owner: 'root', group: 'root', mode: '0644' }
    - { src: '000-default.conf', dest: '/etc/apache2/sites-available/000-default.conf', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'jibux.info.conf', dest: '/etc/apache2/sites-available/jibux.info.conf', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'security.conf', dest: '/etc/apache2/conf-available/security.conf', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'jb_dedi_web.conf', dest: '/etc/php/7.0/fpm/pool.d/jb_dedi_web.conf', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'php-fpm.conf', dest: '/etc/php/7.0/fpm/php-fpm.conf', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'php.ini', dest: '/etc/php/7.0/fpm/php.ini', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'sslh', dest: '/etc/default/sslh', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'my.cnf', dest: '/etc/mysql/my.cnf', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'rules.v4', dest: '/etc/iptables/rules.v4', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'rules.v6', dest: '/etc/iptables/rules.v6', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'sudoers', dest: '/etc/sudoers', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'sshd_config', dest: '/etc/ssh/sshd_config', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'interfaces', dest: '/etc/network/interfaces', owner: 'root', group: 'root', mode: '0644' }
  register: config_webserver

- name: Setup logrotate files
  copy: owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} src={{ item.src }} dest={{ item.dest }}
  with_items: 
    - { src: 'apache2-private', dest: '/etc/logrotate.d/apache2-private', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'renew_lets_encrypt', dest: '/etc/logrotate.d/renew_lets_encrypt', owner: 'root', group: 'root', mode: '0644' }
    - { src: 'openvpn', dest: '/etc/logrotate.d/openvpn', owner: 'root', group: 'root', mode: '0644' }

- name: Disable cron in /etc/cron.d/certbot
  replace:
    path: /etc/cron.d/certbot
    regexp: '(^0.*)'
    replace: '#\1'

- name: Stat /etc/php/7.0/fpm/pool.d/www.conf
  stat: path=/etc/php/7.0/fpm/pool.d/www.conf
  register: www_conf_stat

- name: Move www.conf to www.conf.dist
  command: mv /etc/php/7.0/fpm/pool.d/www.conf /etc/php/7.0/fpm/pool.d/www.conf.dist
  when: www_conf_stat.stat.exists

- name: Enable site for apache2
  shell: a2ensite {{ item }}
  with_items:
    - jibux.info.conf
    - 000-default.conf
  when: config_webserver.changed

- name: Stop fail2ban services
  systemd: state=stopped name=fail2ban
  when: config_webserver.changed

- name: Execute iptables
  shell: /home/data/scripts/iptables/iptables.sh load
  when: config_webserver.changed

- name: Restart services (1/3)
  systemd: state=restarted enabled=yes name={{ item }}
  with_items:
    - fail2ban
    - ssh
    - php7.0-fpm
    - mariadb
  when: config_webserver.changed

- name: Restart services - stop (2/3)
  systemd: state=stopped enabled=yes name={{ item }}
  with_items:
    - openvpn
    - apache2
    - sslh
  when: config_webserver.changed

- name: Restart services - start (3/3)
  systemd: state=started enabled=yes name={{ item }}
  with_items:
    - openvpn
    - apache2
    - sslh
  when: config_webserver.changed


